generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model AuditLog {
  id            String   @id
  action        String
  adminId       String
  adminEmail    String
  timestamp     DateTime @default(now())
  affectedModel String?
  affectedId    String?
  beforeData    String?
  afterData     String?
  ipAddress     String?
  userAgent     String?

  @@index([action])
  @@index([adminId])
  @@index([timestamp])
}

model Campaign {
  id            String   @id
  title         String
  description   String
  titleTr       String?
  descriptionTr String?
  titleAr       String?
  descriptionAr String?
  titleDe       String?
  descriptionDe String?
  titleEs       String?
  descriptionEs String?
  titleKo       String?
  descriptionKo String?
  titleRu       String?
  descriptionRu String?
  titleZh       String?
  descriptionZh String?
  startDate     DateTime
  endDate       DateTime
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  Task          Task[]

  @@index([endDate])
  @@index([isActive])
  @@index([startDate])
}

model Completion {
  id                     String                   @id
  userId                 String
  taskId                 String
  completedAt            DateTime                 @default(now())
  pointsAwarded          Int                      @default(0)
  status                 String                   @default("PENDING")
  verificationStatus     String                   @default("UNVERIFIED")
  needsReview            Boolean                  @default(false)
  reviewedBy             String?
  reviewedAt             DateTime?
  fraudScore             Int                      @default(0)
  autoApproveAt          DateTime?
  rejectionReason        String?
  completionTime         Int?
  ipAddress              String?
  userAgent              String?
  scheduledFor           DateTime?
  actualDeadline         DateTime?
  isExpired              Boolean                  @default(false)
  missedAt               DateTime?
  Task                   Task                     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  User                   User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  TwitterVerificationLog TwitterVerificationLog[]

  @@index([actualDeadline])
  @@index([autoApproveAt])
  @@index([completedAt])
  @@index([isExpired])
  @@index([missedAt])
  @@index([needsReview])
  @@index([status])
  @@index([taskId, completedAt])
  @@index([taskId])
  @@index([userId, completedAt])
  @@index([userId])
  @@index([userId, status, taskId])
}

model EmailLog {
  id        String    @id
  to        String
  subject   String
  template  String
  status    String
  error     String?
  sentAt    DateTime  @default(now())
  openedAt  DateTime?
  clickedAt DateTime?

  @@index([sentAt])
  @@index([status])
  @@index([template])
  @@index([to])
}

model EmailPreference {
  id                  String    @id
  userId              String    @unique
  taskCompletions     Boolean   @default(true)
  walletVerifications Boolean   @default(true)
  adminNotifications  Boolean   @default(true)
  marketingEmails     Boolean   @default(false)
  unsubscribedAt      DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime
  User                User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ErrorReport {
  id                 String               @id
  userId             String?
  userEmail          String?
  errorType          String
  errorTitle         String
  errorMessage       String
  stackTrace         String?
  pageUrl            String
  userAgent          String?
  screenshot         String?
  status             String               @default("PENDING")
  priority           String               @default("MEDIUM")
  assignedTo         String?
  resolvedBy         String?
  resolvedAt         DateTime?
  resolution         String?
  viewCount          Int                  @default(0)
  responseTime       Int?
  resolutionTime     Int?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  User               User?                @relation(fields: [userId], references: [id])
  ErrorReportComment ErrorReportComment[]
  ErrorReportTag     ErrorReportTag[]

  @@index([assignedTo])
  @@index([createdAt])
  @@index([errorType])
  @@index([priority])
  @@index([status])
  @@index([userId])
}

model ErrorReportComment {
  id            String      @id
  errorReportId String
  userId        String
  comment       String
  isInternal    Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime
  ErrorReport   ErrorReport @relation(fields: [errorReportId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([errorReportId])
  @@index([userId])
}

model ErrorReportTag {
  id            String      @id
  errorReportId String
  tag           String
  createdAt     DateTime    @default(now())
  ErrorReport   ErrorReport @relation(fields: [errorReportId], references: [id], onDelete: Cascade)

  @@unique([errorReportId, tag])
  @@index([errorReportId])
  @@index([tag])
}

model FilterPreset {
  id        String   @id
  name      String
  criteria  String
  createdBy String
  createdAt DateTime @default(now())
  User      User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([createdBy])
}

model LoginLog {
  id        String   @id
  userId    String
  ipAddress String
  userAgent String?
  success   Boolean  @default(true)
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([userId])
}

model PointAdjustment {
  id               String            @id
  userId           String
  amount           Int
  reason           String
  reactionId       String?
  createdAt        DateTime          @default(now())
  verifiedAt       DateTime?
  TelegramReaction TelegramReaction? @relation(fields: [reactionId], references: [id])
  User             User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([reason])
  @@index([userId])
}

model Role {
  id          String   @id
  name        String   @unique
  permissions String
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  User        User[]
}

model SearchHistory {
  id          String   @id
  userId      String
  query       String
  resultCount Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([createdAt])
  @@index([userId, createdAt])
  @@index([userId])
}

model Task {
  id                     String                   @id
  campaignId             String
  title                  String
  description            String
  titleTr                String?
  descriptionTr          String?
  titleAr                String?
  descriptionAr          String?
  titleDe                String?
  descriptionDe          String?
  titleEs                String?
  descriptionEs          String?
  titleKo                String?
  descriptionKo          String?
  titleRu                String?
  descriptionRu          String?
  titleZh                String?
  descriptionZh          String?
  points                 Int
  taskType               String
  taskUrl                String?
  isActive               Boolean                  @default(true)
  scheduledDeadline      DateTime?
  estimatedDuration      Int?
  isTimeSensitive        Boolean                  @default(false)
  duration               Int?
  expiresAt              DateTime?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  Completion             Completion[]
  Campaign               Campaign                 @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  TwitterVerificationLog TwitterVerificationLog[]

  @@index([campaignId])
  @@index([expiresAt])
  @@index([isActive])
  @@index([isTimeSensitive])
  @@index([scheduledDeadline])
}

model TelegramReaction {
  id              String            @id
  userId          String
  telegramUserId  String
  postId          String
  chatId          String
  reactionEmoji   String
  pointsAwarded   Int               @default(20)
  isActive        Boolean           @default(true)
  createdAt       DateTime          @default(now())
  removedAt       DateTime?
  lastVerifiedAt  DateTime?
  PointAdjustment PointAdjustment[]
  User            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId, reactionEmoji])
  @@index([createdAt])
  @@index([isActive])
  @@index([postId])
  @@index([telegramUserId])
  @@index([userId])
}

model TwitterConnection {
  id                     String                   @id
  userId                 String                   @unique
  twitterId              String                   @unique
  username               String
  displayName            String?
  profileImageUrl        String?
  accessToken            String
  refreshToken           String
  tokenExpiresAt         DateTime
  scope                  String
  tokenType              String                   @default("Bearer")
  isActive               Boolean                  @default(true)
  lastVerifiedAt         DateTime?
  connectedAt            DateTime                 @default(now())
  updatedAt              DateTime
  User                   User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  TwitterVerificationLog TwitterVerificationLog[]

  @@index([isActive])
  @@index([tokenExpiresAt])
  @@index([twitterId])
  @@index([userId])
}

model TwitterVerificationLog {
  id                  String             @id
  completionId        String
  userId              String
  taskId              String
  taskType            String
  verificationResult  String
  twitterApiResponse  String?
  errorMessage        String?
  rejectionReason     String?
  verificationTime    Int
  apiCallCount        Int
  cacheHit            Boolean            @default(false)
  twitterConnectionId String?
  verifiedAt          DateTime           @default(now())
  Completion          Completion         @relation(fields: [completionId], references: [id], onDelete: Cascade)
  Task                Task               @relation(fields: [taskId], references: [id], onDelete: Cascade)
  TwitterConnection   TwitterConnection? @relation(fields: [twitterConnectionId], references: [id])
  User                User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([completionId])
  @@index([taskId])
  @@index([taskType])
  @@index([twitterConnectionId])
  @@index([userId])
  @@index([verificationResult])
  @@index([verifiedAt])
}

model User {
  id                     String                   @id
  email                  String                   @unique
  username               String                   @unique
  password               String
  role                   String                   @default("USER")
  roleId                 String?
  status                 String                   @default("ACTIVE")
  referralCode           String?                  @unique
  invitedBy              String?
  avatarUrl              String?
  walletAddress          String?                  @unique
  walletVerified         Boolean                  @default(false)
  twitterUsername        String?                  @unique
  twitterVerified        Boolean                  @default(false)
  telegramUsername       String?                  @unique
  telegramVerified       Boolean                  @default(false)
  totalPoints            Int                      @default(0)
  acceptedTerms          Boolean                  @default(false)
  acceptedPrivacy        Boolean                  @default(false)
  termsAcceptedAt        DateTime?
  createdAt              DateTime                 @default(now())
  lastActive             DateTime                 @default(now())
  Completion             Completion[]
  EmailPreference        EmailPreference?
  ErrorReport            ErrorReport[]
  FilterPreset           FilterPreset[]
  LoginLog               LoginLog[]
  PointAdjustment        PointAdjustment[]
  TelegramReaction       TelegramReaction[]
  TwitterConnection      TwitterConnection?
  TwitterVerificationLog TwitterVerificationLog[]
  Role                   Role?                    @relation(fields: [roleId], references: [id])
  UserNotification       UserNotification[]
  Workflow               Workflow[]

  @@index([email])
  @@index([invitedBy])
  @@index([referralCode])
  @@index([roleId])
  @@index([status])
  @@index([telegramUsername])
  @@index([totalPoints])
  @@index([twitterUsername])
  @@index([walletAddress])
}

model UserNotification {
  id           String    @id
  userId       String
  type         String
  title        String
  message      String
  pointsChange Int
  isRead       Boolean   @default(false)
  showOnLogin  Boolean   @default(true)
  createdAt    DateTime  @default(now())
  readAt       DateTime?
  User         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([isRead])
  @@index([showOnLogin])
  @@index([userId])
}

model Workflow {
  id        String   @id
  name      String
  trigger   String
  actions   String
  isActive  Boolean  @default(true)
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([createdBy])
  @@index([isActive])
}
